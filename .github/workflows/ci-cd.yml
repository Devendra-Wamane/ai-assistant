name: ğŸš€ AI Assistant - Complete CI/CD

# Single workflow that handles everything automatically
on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/ai-assistant

jobs:
  # ğŸ§ª Test Phase
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt pytest httpx
    
    - name: ğŸ§ª Run tests
      run: pytest test_app.py -v

  # ğŸ”’ Security Scan
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    - uses: pypa/gh-action-pip-audit@v1.0.8
      with:
        inputs: requirements.txt

  # ğŸš‚ Deploy to Railway
  deploy:
    name: ğŸš‚ Deploy to Railway
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸš‚ Deploy to Railway
      uses: bervProject/railway-deploy@main
      with:
        railway_token: ${{ secrets.RAILWAY_TOKEN }}
        service: "ai-assistant"
        
    - name: âœ… Deployment Success
      run: |
        echo "ğŸ‰ SUCCESS: AI Assistant deployed!"
        echo ""
        echo "ğŸŒ Your AI Assistant is LIVE at:"
        echo "   â€¢ Main App: https://your-app.railway.app/"
        echo "   â€¢ API Docs: https://your-app.railway.app/docs"
        echo "   â€¢ Health: https://your-app.railway.app/health"
        echo ""
        echo "ğŸ’¬ Test your AI:"
        echo "   Ask: 'What is Docker?' or 'Explain Kubernetes'"
        echo ""
        echo "ğŸ“± Check Railway dashboard: https://railway.app/"